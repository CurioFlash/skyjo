<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skyjo Ultimate</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #1a1a2e; --panel: #16213e; --accent: #e94560; --turn: #00ff00; --text: #fff; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; padding-bottom: 100px; overflow-x: hidden; }
        .hidden { display: none !important; }
        
        .btn { background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; }
        .btn-green { background: #27ae60; }
        .btn-admin { background: #533483; font-size: 10px; padding: 5px 10px; }
        .disabled { opacity: 0.5; pointer-events: none; }

        #login-screen { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #000; }
        input { padding: 12px; border-radius: 8px; border: 1px solid #533483; background: #0f3460; color: white; margin: 10px; text-align: center; }
        
        .top-bar { padding: 10px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; }
        
        #opponents { display: flex; flex-wrap: wrap; justify-content: space-around; gap: 5px; padding: 5px; }
        .opp-area { width: 45%; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 8px; border: 1px solid transparent; position: relative; }

        .center-table { display: flex; justify-content: center; gap: 40px; margin: 15px 0; }
        
        .card { width: 40px; height: 65px; border-radius: 6px; display: flex; justify-content: center; align-items: center; font-weight: 900; font-size: 16px; background: #0f3460; border: 2px solid #ccc; position: relative; transition: transform 0.2s; }
        .card-hidden { background: repeating-linear-gradient(45deg, #0f3460, #0f3460 10px, #16213e 10px, #16213e 20px); color: transparent; }
        .flying-card { position: fixed; z-index: 9999; pointer-events: none; transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 10px 20px rgba(0,0,0,0.5); border-radius: 6px; }
        
        .selected { border: 3px solid #f1c40f !important; transform: scale(1.05); box-shadow: 0 0 10px #f1c40f; }
        .last-played { border: 3px solid #00d2d3 !important; box-shadow: 0 0 15px #00d2d3; z-index: 10; }

        .c-neg { background: #6c5ce7 !important; color: white !important; }
        .c-zero { background: #00cec9 !important; color: white !important; }
        .c-low { background: #badc58 !important; color: #333 !important; }
        .c-mid { background: #f1c40f !important; color: #333 !important; }
        .c-high { background: #e74c3c !important; color: white !important; }
        .c-cleared { opacity: 0.1; background: transparent !important; border: 1px dashed #555; color: transparent !important; }

        .player-area { background: rgba(255,255,255,0.08); padding: 10px; margin: 10px; border-radius: 10px; border: 2px solid transparent; }
        .my-turn { border-color: var(--turn) !important; box-shadow: 0 0 10px rgba(0,255,0,0.2); }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 3px; width: fit-content; margin: 0 auto; }
        .opp-card { width: 20px; height: 32px; font-size: 10px; border-width: 1px; }

        #win-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; overflow-y: auto; }
        .podium-item { background: var(--panel); width: 100%; max-width: 300px; padding: 10px; margin: 3px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--accent); }
        .gold { border-left-color: #ffd700; background: rgba(255, 215, 0, 0.1); }
        .penalty-text { color: #e94560; font-weight: bold; font-size: 10px; }

        #chat-btn { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--accent); display: flex; justify-content: center; align-items: center; z-index: 200; transition: transform 0.2s; }
        .chat-anim { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(233, 69, 96, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(233, 69, 96, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(233, 69, 96, 0); } }
        #chat-badge { position: absolute; top: 0; right: 0; width: 15px; height: 15px; background: #00ff00; border-radius: 50%; border: 2px solid var(--bg); display: none; }
        #chat-panel { position: fixed; bottom: 80px; right: 20px; width: 280px; height: 350px; background: #222; border-radius: 10px; display: none; flex-direction: column; z-index: 199; border: 1px solid #444; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 10px; font-size: 12px; }
        
        .admin-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #000; padding: 5px; display: flex; justify-content: center; gap: 10px; font-size: 10px; z-index: 100; border-top: 1px solid #333; }
        
        #lobby-list { text-align:center; margin: 20px; color: #aaa; font-size: 14px; }
        #fireworks-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 99999; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

<canvas id="fireworks-canvas"></canvas>

<div id="login-screen">
    <h1>SKYJO ULTIMATE</h1>
    <input type="text" id="username" placeholder="Pseudo">
    <input type="text" id="room-code" placeholder="Code Salon">
    <button class="btn" onclick="checkAndJoin()">REJOINDRE</button>
</div>

<div id="game-screen" class="hidden">
    <div class="top-bar">
        <button onclick="document.getElementById('win-screen').classList.remove('hidden')" class="btn btn-admin">SCORES</button>
        <div id="status-text">Attente...</div>
        <button id="admin-start-btn" class="btn btn-green hidden" onclick="startGame(false)">LANCER LA PARTIE</button>
        <button onclick="confirmExit()" style="background:none; border:none; color:white;"><i class="fas fa-times"></i></button>
    </div>

    <div id="lobby-list" class="hidden">
        <h3>JOUEURS CONNECT√âS :</h3>
        <div id="lobby-players"></div>
    </div>

    <div id="opponents"></div>

    <div class="center-table">
        <div onclick="drawFromDeck()">
            <div style="text-align:center; font-size:10px;">PIOCHE <span id="deck-count" style="font-size:8px; opacity:0.7"></span></div>
            <div id="deck-pile" class="card"><i class="fas fa-layer-group"></i></div>
        </div>
        <div onclick="clickDiscard()">
            <div style="text-align:center; font-size:10px;">DEFAUSSE</div>
            <div id="discard-pile" class="card">?</div>
        </div>
    </div>

    <div id="my-area" class="player-area">
        <h3 style="margin:0 0 5px 0; font-size:14px;">MOI <span id="my-score"></span></h3>
        <div id="my-grid" class="grid"></div>
    </div>

    <div id="admin-controls" class="admin-bar hidden">
        <span>ADMIN:</span>
        <button id="btn-next-round" class="btn btn-admin" onclick="nextRoundSafe()">MANCHE SUIVANTE</button>
        <button class="btn btn-admin" style="background:#c0392b" onclick="startGame(true)">RESET TOTAL</button>
    </div>
</div>

<div id="win-screen" class="hidden">
    <h2 id="win-title" style="color: #ffd700; margin-top:0;">CLASSEMENT</h2>
    <div id="podium-list"></div>
    <div style="margin-top:20px; display:flex; flex-direction:column; gap:10px; width:200px;">
        <button id="admin-restart-win" class="btn btn-green hidden" onclick="nextRoundSafe()">MANCHE SUIVANTE</button>
        <button class="btn" onclick="document.getElementById('win-screen').classList.add('hidden')">RETOUR AU JEU</button>
    </div>
</div>

<div id="chat-btn" onclick="toggleChat()">
    <i class="fas fa-comment"></i>
    <div id="chat-badge"></div>
</div>
<div id="chat-panel">
    <div style="padding:10px; background:#333; border-radius:10px 10px 0 0; font-size:12px; display:flex; justify-content:space-between;">
        <span>Chat</span> <span style="cursor:pointer" onclick="toggleChat()">X</span>
    </div>
    <div id="chat-msgs"></div>
    <div style="display:flex; padding:5px; background:#111;">
        <input type="text" id="chat-input" style="flex:1; margin:0; padding:8px;" placeholder="...">
        <button onclick="sendChat()" class="btn" style="padding:0 15px;">OK</button>
    </div>
</div>

<script>
    window.addEventListener('beforeunload', (e) => { e.preventDefault(); e.returnValue = ''; });
    function confirmExit() { if(confirm("Quitter ?")) location.reload(); }

    var config = {
        apiKey: "AIzaSyAXE1jp9yRQ3riMB4Y-HohTRvYtij2i1t4",
        authDomain: "webskyjo.firebaseapp.com",
        databaseURL: "https://webskyjo-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "webskyjo",
        storageBucket: "webskyjo.firebasestorage.app",
        messagingSenderId: "650976044098",
        appId: "1:650976044098:web:7f8b4f8ec53c81354c39db"
    };

    if (!firebase.apps.length) firebase.initializeApp(config);
    var db = firebase.database();
    
    var myId = "u" + Math.floor(Math.random() * 999999);
    var myName, roomCode, gameState = {};
    var takingDiscard = false, mustFlip = false, chatOpen = false;
    var chatSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

    // CONNEXION
    function checkAndJoin() {
        var inputName = document.getElementById('username').value.trim();
        var inputCode = document.getElementById('room-code').value.trim().toUpperCase();
        if(!inputName || !inputCode) return;

        db.ref('rooms/'+inputCode).once('value', snap => {
            var val = snap.val();
            
            if(!val) { // Cr√©ation salle
                myName = inputName; roomCode = inputCode;
                createPlayerAndJoin();
                db.ref('rooms/'+roomCode).update({status: 'waiting', stack: []});
                return;
            }

            var players = val.players || {};
            var existingId = Object.keys(players).find(key => players[key].name === inputName);

            if(val.status === 'playing') {
                if(existingId) { // Reconnexion
                    myId = existingId; myName = inputName; roomCode = inputCode;
                    goToGame();
                } else {
                    alert("Impossible : Partie en cours !");
                }
            } else { // Lobby
                myName = inputName; roomCode = inputCode;
                if(existingId) myId = existingId;
                createPlayerAndJoin();
            }
        });
    }

    function createPlayerAndJoin() {
        db.ref('rooms/'+roomCode+'/players/'+myId).update({name:myName, id:myId, totalScore:0}, (error) => {
            if(!error) goToGame();
        });
    }

    function goToGame() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        startListening();
    }

    function startListening() {
        db.ref('rooms/'+roomCode).on('value', snap => { if(snap.val()) { gameState = snap.val(); render(); } });
        db.ref('rooms/'+roomCode+'/chat').on('child_added', snap => {
            var m = snap.val(); 
            document.getElementById('chat-msgs').innerHTML += `<div style="margin-bottom:4px;"><b>${m.name}:</b> ${m.text}</div>`;
            var d = document.getElementById('chat-msgs'); d.scrollTop = d.scrollHeight;
            if(!chatOpen) {
                document.getElementById('chat-badge').style.display = 'block';
                document.getElementById('chat-btn').classList.add('chat-anim');
                chatSound.play().catch(e => {}); 
            }
        });
    }

    function drawFromDeck() {
        if(gameState.status !== 'playing') return;
        if(gameState.turn !== myId || gameState.tempDraw || mustFlip || takingDiscard) return;
        
        if(!gameState.deck || gameState.deck.length === 0) {
            var stack = gameState.stack || [];
            if(stack.length === 0) return alert("Plus de cartes !");
            stack.sort(() => Math.random() - 0.5);
            db.ref('rooms/'+roomCode).update({ deck: stack, stack: [] });
            setTimeout(() => {
                db.ref('rooms/'+roomCode+'/deck').once('value', s => {
                    var newDeck = s.val();
                    var card = newDeck.pop();
                    db.ref('rooms/'+roomCode).update({ deck: newDeck, tempDraw: card });
                });
            }, 500);
            return;
        }

        var card = gameState.deck.pop(); 
        db.ref('rooms/'+roomCode).update({ deck: gameState.deck, tempDraw: card });
    }

    function clickDiscard() {
        if(gameState.status !== 'playing') return;
        if(gameState.turn !== myId) return;
        if(gameState.tempDraw !== null && gameState.tempDraw !== undefined) {
            var val = gameState.tempDraw; animateFly('deck-pile', 'discard-pile', val);
            mustFlip = true; 
            var oldStack = gameState.stack || []; oldStack.push(gameState.discard);
            db.ref('rooms/'+roomCode).update({ tempDraw: null, discard: val, stack: oldStack });
        } else if(!mustFlip) { 
            takingDiscard = !takingDiscard; render(); 
        }
    }

    function clickMyCard(idx) {
        if(gameState.status !== 'playing') return;
        if(gameState.turn !== myId) return;
        var grid = JSON.parse(JSON.stringify(gameState.players[myId].grid));
        var oldStack = gameState.stack || [];

        if(mustFlip) {
            if(grid[idx].visible) return; 
            grid[idx].visible = true;
            finishTurn(grid, gameState.discard, oldStack, idx); 
            mustFlip = false;
        } else if(gameState.tempDraw !== null && gameState.tempDraw !== undefined) {
            var newVal = gameState.tempDraw; var oldVal = grid[idx].val;
            oldStack.push(gameState.discard);
            db.ref('rooms/'+roomCode).update({ tempDraw: null }); 
            animateFly('deck-pile', 'my-card-'+idx, newVal, () => {
                animateFly('my-card-'+idx, 'discard-pile', oldVal);
                grid[idx] = {val: newVal, visible:true, cleared:false}; 
                finishTurn(grid, oldVal, oldStack, idx);
            });
        } else if(takingDiscard) {
            var newVal = gameState.discard; var oldVal = grid[idx].val; takingDiscard = false;
            animateFly('discard-pile', 'my-card-'+idx, newVal, () => {
                animateFly('my-card-'+idx, 'discard-pile', oldVal);
                grid[idx] = {val: newVal, visible:true, cleared:false}; 
                finishTurn(grid, oldVal, oldStack, idx);
            });
        }
    }

    function finishTurn(grid, newDiscard, stack, lastIdx) {
        var colCleared = false; var valCleared = null;
        for(var c=0; c<4; c++){
            if(grid[c].val===grid[c+4].val && grid[c+4].val===grid[c+8].val && grid[c].visible && grid[c+4].visible && grid[c+8].visible && !grid[c].cleared){
                grid[c].cleared = grid[c+4].cleared = grid[c+8].cleared = true;
                colCleared = true; valCleared = grid[c].val;
            }
        }

        if(colCleared) {
            launchFireworks(); 
            stack.push(newDiscard); 
            stack.push(valCleared); stack.push(valCleared); 
            newDiscard = valCleared; 
        }

        var pIds = Object.keys(gameState.players);
        var next = pIds[(pIds.indexOf(myId)+1)%pIds.length];
        var allVis = grid.every(c => c.visible);
        var fin = gameState.finisher || (allVis ? myId : null);
        
        var up = { 
            ['players/'+myId+'/grid']: grid, 
            discard: newDiscard, stack: stack,
            lastAction: { player: myId, index: lastIdx }
        };

        if(fin && next === fin) {
            up.status = "finished"; up.turn = "END";
            let roundScores = {};
            pIds.forEach(pid => {
                let pGrid = (pid === myId) ? grid : gameState.players[pid].grid;
                pGrid.forEach(c => c.visible = true);
                roundScores[pid] = calculateScore(pGrid);
                up['players/'+pid+'/grid'] = pGrid;
            });
            
            let finisherScore = roundScores[fin];
            let isDoubled = false;
            pIds.forEach(pid => { if(pid !== fin && roundScores[pid] < finisherScore) isDoubled = true; });

            pIds.forEach(pid => {
                let s = roundScores[pid];
                let penalty = false;
                if(pid === fin && isDoubled && s > 0) { s *= 2; penalty = true; }
                up['players/'+pid+'/lastRound'] = s;
                up['players/'+pid+'/penalty'] = penalty;
                up['players/'+pid+'/totalScore'] = (gameState.players[pid].totalScore || 0) + s;
            });
        } else { up.turn = next; }
        if(allVis && !gameState.finisher) up.finisher = myId;
        
        db.ref('rooms/'+roomCode).update(up);
    }

    function render() {
        var pIds = Object.keys(gameState.players || {});
        var isAdmin = pIds[0] === myId;
        var isWaiting = gameState.status === 'waiting' || !gameState.status;
        
        document.getElementById('lobby-list').classList.toggle('hidden', !isWaiting);
        document.getElementById('game-screen').classList.toggle('hidden', false);
        document.getElementById('opponents').classList.toggle('hidden', isWaiting);
        document.getElementById('my-area').classList.toggle('hidden', isWaiting);
        document.querySelector('.center-table').classList.toggle('hidden', isWaiting);

        if(isWaiting) {
            document.getElementById('status-text').innerText = "EN ATTENTE...";
            document.getElementById('lobby-players').innerHTML = pIds.map(pid => `<div>${gameState.players[pid].name}</div>`).join('');
            document.getElementById('admin-start-btn').classList.toggle('hidden', !isAdmin);
        } else {
            document.getElementById('admin-start-btn').classList.add('hidden');
        }

        document.getElementById('admin-controls').classList.toggle('hidden', !isAdmin || isWaiting);
        document.getElementById('admin-restart-win').classList.toggle('hidden', !isAdmin);

        if(gameState.status === 'finished') showWinScreen(pIds);

        if(!isWaiting) {
            document.getElementById('status-text').innerText = (gameState.turn === myId) ? "üëâ √Ä TOI !" : "Attente du tour...";
            document.getElementById('discard-pile').innerText = gameState.discard;
            document.getElementById('discard-pile').className = "card revealed " + getColor(gameState.discard) + (takingDiscard ? " selected" : "");
            document.getElementById('deck-count').innerText = (gameState.deck ? gameState.deck.length : 0) + " cartes";
            
            var pEl = document.getElementById('deck-pile');
            if(gameState.tempDraw !== null && gameState.tempDraw !== undefined) {
                pEl.innerText = gameState.tempDraw; pEl.className = "card revealed selected " + getColor(gameState.tempDraw);
            } else {
                pEl.innerHTML = '<i class="fas fa-layer-group"></i>'; pEl.className = "card card-hidden";
            }

            var myData = gameState.players[myId];
            if(myData && myData.grid) {
                var myGrid = document.getElementById('my-grid'); myGrid.innerHTML = '';
                myData.grid.forEach((c, i) => {
                    var div = document.createElement('div'); div.id = "my-card-"+i;
                    var isLast = (gameState.lastAction && gameState.lastAction.player === myId && gameState.lastAction.index === i);
                    div.className = "card " + (c.visible ? "revealed "+getColor(c.val) : "card-hidden") + (c.cleared ? " c-cleared":"") + (isLast ? " last-played":"");
                    div.innerText = c.visible ? c.val : ""; div.onclick = () => clickMyCard(i);
                    myGrid.appendChild(div);
                });
                document.getElementById('my-score').innerText = "(" + calculateScore(myData.grid) + ") Total: " + (myData.totalScore || 0);
                document.getElementById('my-area').className = "player-area " + (gameState.turn === myId ? "my-turn":"");
            }

            var opp = document.getElementById('opponents'); opp.innerHTML = '';
            pIds.forEach(pid => {
                if(pid === myId) return;
                var p = gameState.players[pid]; if(!p.grid) return;
                var div = document.createElement('div'); div.className = "opp-area " + (gameState.turn === pid ? "my-turn":"");
                var h = `<div style="font-size:10px; text-align:center;"><b>${p.name}</b><br>Tour: ${calculateScore(p.grid)} | Total: ${p.totalScore || 0}</div><div class="grid">`;
                p.grid.forEach((c, i) => { 
                    var isLast = (gameState.lastAction && gameState.lastAction.player === pid && gameState.lastAction.index === i);
                    h += `<div class="card opp-card ${c.visible?'revealed '+getColor(c.val):''} ${c.cleared?'c-cleared':''} ${isLast?'last-played':''}">${c.visible?c.val:''}</div>`; 
                });
                div.innerHTML = h + `</div>`; opp.appendChild(div);
            });
        }
    }

    function showWinScreen(pIds) {
        var win = document.getElementById('win-screen'); var list = document.getElementById('podium-list');
        win.classList.remove('hidden'); list.innerHTML = '';
        var scores = pIds.map(id => ({ 
            name: gameState.players[id].name, 
            last: gameState.players[id].lastRound || 0,
            total: gameState.players[id].totalScore || 0,
            penalty: gameState.players[id].penalty
        })).sort((a,b) => a.total - b.total);
        
        document.getElementById('win-title').innerText = (scores.some(s => s.total >= 100)) ? "PARTIE TERMIN√âE !" : "SCORES G√âN√âRAUX";

        scores.forEach((s, i) => {
            list.innerHTML += `<div class="podium-item ${i===0?'gold':''}">
                <span>${i===0?'üèÜ':i+1+'.'} <b>${s.name}</b></span>
                <div style="text-align:right">
                    <span style="font-size:12px;">+${s.last} ${s.penalty?'<span class="penalty-text">DOUBL√â!</span>':''}</span><br>
                    <b>Total: ${s.total}</b>
                </div>
            </div>`;
        });
    }

    function calculateScore(g) { return g.reduce((sum, c) => (c.visible && !c.cleared) ? sum + c.val : sum, 0); }
    function getColor(v) { if(v < 0) return 'c-neg'; if(v == 0) return 'c-zero'; if(v <= 4) return 'c-low'; if(v <= 8) return 'c-mid'; return 'c-high'; }

    var loadingNext = false;
    function nextRoundSafe() {
        if(loadingNext) return; loadingNext = true;
        document.getElementById('btn-next-round').classList.add('disabled');
        startGame(false);
        setTimeout(() => { loadingNext = false; document.getElementById('btn-next-round').classList.remove('disabled'); }, 3000);
    }

    function startGame(resetTotal) {
        // DISTRIBUTION EXACTE V7.1
        var d = []; 
        for(let i=0; i<5; i++) d.push(-2);
        for(let i=0; i<10; i++) d.push(-1);
        for(let i=0; i<15; i++) d.push(0);
        for(let v=1; v<=12; v++) { for(let k=0; k<10; k++) d.push(v); }
        d.sort(() => Math.random() - 0.5);
        
        var up = { 
            deck: d, discard: d.pop(), stack: [], status:'playing', 
            turn: Object.keys(gameState.players)[0], tempDraw: null, finisher: null, lastAction: null 
        };
        
        Object.keys(gameState.players).forEach(pid => {
            var g = []; for(var k=0; k<12; k++) g.push({val: d.pop(), visible:false, cleared:false});
            g[0].visible = g[1].visible = true;
            up['players/'+pid+'/grid'] = g;
            up['players/'+pid+'/lastRound'] = 0;
            up['players/'+pid+'/penalty'] = false;
            if(resetTotal) up['players/'+pid+'/totalScore'] = 0;
        });
        db.ref('rooms/'+roomCode).update(up);
    }

    function toggleChat() { 
        chatOpen = !chatOpen; 
        document.getElementById('chat-panel').style.display = chatOpen ? 'flex' : 'none'; 
        if(chatOpen) {
            document.getElementById('chat-badge').style.display = 'none';
            document.getElementById('chat-btn').classList.remove('chat-anim');
        }
    }
    function sendChat() { var i = document.getElementById('chat-input'); if(!i.value) return; db.ref('rooms/'+roomCode+'/chat').push({name:myName, text:i.value}); i.value = ''; }
    
    function animateFly(fromId, toId, value, callback) {
        const fromEl = document.getElementById(fromId); const toEl = document.getElementById(toId);
        if(!fromEl || !toEl) { if(callback) callback(); return; }
        const rF = fromEl.getBoundingClientRect(); const rT = toEl.getBoundingClientRect();
        const fly = document.createElement('div'); fly.className = "card flying-card revealed " + getColor(value);
        fly.innerText = value; fly.style.left = rF.left + "px"; fly.style.top = rF.top + "px";
        document.body.appendChild(fly);
        setTimeout(() => { fly.style.left = rT.left + "px"; fly.style.top = rT.top + "px"; fly.style.transform = "rotate(360deg)"; }, 50);
        setTimeout(() => { fly.remove(); if(callback) callback(); }, 600);
    }

    function launchFireworks() {
        const canvas = document.getElementById('fireworks-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let particles = [];
        function createParticle(x, y) {
            const count = 30;
            for(let i=0; i<count; i++) {
                particles.push({x: x, y: y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, alpha: 1, color: `hsl(${Math.random()*360}, 100%, 50%)`});
            }
        }
        createParticle(window.innerWidth/2, window.innerHeight/2);
        function update() {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            particles.forEach((p, index) => {
                p.x += p.vx; p.y += p.vy; p.alpha -= 0.02;
                ctx.globalAlpha = p.alpha; ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
                if(p.alpha <= 0) particles.splice(index, 1);
            });
            if(particles.length > 0) requestAnimationFrame(update);
            else ctx.clearRect(0,0, canvas.width, canvas.height);
        }
        update();
    }
</script>
</body>
</html>
